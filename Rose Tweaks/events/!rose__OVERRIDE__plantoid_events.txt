namespace = plant

planet_event = {
	id = plant.115
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		OR = {
			has_active_building = building_gaiaseeders_4
			has_active_building = building_gaiaseeders_pc_gaia
		}
		has_planet_flag = gaia_seeder_bloom
	}

	immediate = {
		owner = {
			set_country_flag = has_bloomed_pops
		}
		set_saved_date = {
			key = gaia_seeder_bloom_timer
			days_from_present = 360
			expires = 360
		}
		set_variable_to_random_value = {
			which = loop_counter
			min = 6
			max = 9
			rounded = yes
		}
		while = {
			count = loop_counter
			weighted_random_owned_pop_group = {
				limit = {
					OR = {
						species = {
							is_flora_species = yes
						}
						AND = {
							species = {
								is_robotic_species = no
							}
							root.owner = {
								has_tradition = tr_mutation_unnatural_selection
							}
						}
					}
					is_being_assimilated = no
					is_being_purged = no
					NOR = {
						has_trait = trait_plantoid_bloomed
						has_trait = trait_malleable_genes
					}
				}
				species = {
					save_event_target_as = old_species
				}
				save_event_target_as = old_pop_group

				if = {
					limit = {
						NOT = {
							any_galaxy_species = {
								has_species_flag = bloomed_species_of_@event_target:old_species
							}
						}
					}
					create_species = {
						is_mod = yes
						name = this
						plural = this
						class = this
						portrait = this
						traits = this
						can_be_modified = this
						homeworld = this
						namelist = this
						gender = this
						traits = {
							trait = trait_plantoid_bloomed
						}
						effect = {
							if = {
								limit = {
									NOR = {
										has_trait = trait_auto_hab_preference
										has_trait = trait_pc_gaia_preference
										has_trait = trait_pc_gaia_preference_terraforming
									}
								}
								set_habitability_trait = { trait = trait_pc_gaia_preference }
							}
							save_event_target_as = target_species
							set_species_flag = bloomed_species_of_@event_target:old_species
						}
					}
				}
				else = {
					random_galaxy_species = {
						limit = {
							has_species_flag = bloomed_species_of_@event_target:old_species
						}
						save_event_target_as = target_species
					}
				}
				planet = {
					create_pop_group = {
						pop_group = event_target:old_pop_group
						species = event_target:target_species
						size = 0
						effect = {
							transfer_pop_amount = {
								source = event_target:old_pop_group
								target = this
								amount = 100
							}
						}
					}
				}
			}
		}
		create_message = {
			type = MESSAGE_POPS_IDYLLIC_BLOOMED
			localization = MESSAGE_POPS_IDYLLIC_BLOOMED
			days = 10
			target = this
			variable = {
				type = name
				localization = PLANET
				scope = this
			}
			variable = {
				type = variable
				localization = VALUE
				scope = this
			}
		}
		planet_event = {
			id = plant.115
			days = 360
		}
	}
}
